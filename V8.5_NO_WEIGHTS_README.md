# V8.5 No Class Weights - README

## 概述

V8.5 无权重版本：结合了 **V8.5 的 38 类覆盖** 和 **V8.1 的无类权重设计**。

## 与其他版本对比

| 特性 | V8.1 | V8.5 原版 | V8.5 无权重 |
|-----|------|----------|------------|
| **行为数量** | 27 | 37 | **37** ✅ |
| **NUM_ACTIONS** | 28 | 38 | **38** ✅ |
| **类权重** | ❌ 无 | ✅ 有 | **❌ 无** |
| **Focal Loss** | γ=1.5 | γ=1.5 | **γ=2.0** ⭐ |
| **架构** | V8 | V8 | **V8** ✅ |
| **竞赛合规** | ❌ | ✅ | **✅** |

## 核心改动

### 1. 禁用类权重
```yaml
# config_v8.5_no_weights.yaml
use_class_weights: false  # ← 核心变化
```

### 2. 提高 Focal Gamma
```yaml
focal_gamma: 2.0  # 从 1.5 提升，补偿无类权重
```

### 3. 其他设置（同 V8.1）
- 学习率: 0.00005
- Batch size: 256
- 优化器: AdamW
- Dropout: 0.0

## 为什么这样设计？

### 优势
✅ **简化训练**: 无需计算类权重（节省 ~30 秒/epoch）
✅ **稳定性**: 避免极端权重（如 ejaculate 的 577× 权重）导致梯度不稳定
✅ **与 V8.1 一致**: 保持熟悉的训练动态
✅ **38 类覆盖**: 符合竞赛要求

### 劣势
⚠️ **稀有行为 F1 低**: ejaculate (3 区间)、biteobject (33 区间) 可能学不到
⚠️ **依赖 Focal Loss**: γ=2.0 可能不足以平衡极端不平衡
⚠️ **收敛慢**: 稀有行为需要更多 epoch 才能学习

## 适用场景

### 推荐使用（✅）
- 想要 38 类覆盖，但不想用类权重
- V8.5 原版训练不稳定（NaN 或梯度爆炸）
- 对稀有行为 F1 要求不高，只需覆盖
- 追求训练速度（无类权重计算）

### 不推荐使用（❌）
- 需要高稀有行为 F1（ejaculate, biteobject 等）
- 竞赛要求所有行为都有预测
- 有充足时间和资源调优类权重

## 使用方法

### 快速启动
```bash
start_v8.5_no_weights.bat
```

### 手动启动
```bash
python train_v8.5_local.py --config configs/config_v8.5_no_weights.yaml
```

### 验证配置
```bash
python -c "import yaml; cfg=yaml.safe_load(open('configs/config_v8.5_no_weights.yaml')); print(f'use_class_weights: {cfg.get(\"use_class_weights\")}'); print(f'focal_gamma: {cfg.get(\"focal_gamma\")}')"
```

**预期输出**:
```
use_class_weights: False
focal_gamma: 2.0
```

## 预期性能

### 与 V8.5 原版对比

| 行为类型 | V8.5 原版 | V8.5 无权重 | 差异 |
|---------|----------|------------|-----|
| **常见行为** (>1000 区间) | F1 ~0.4-0.6 | **F1 ~0.4-0.6** | 无差异 |
| **中等行为** (100-1000) | F1 ~0.3-0.5 | **F1 ~0.25-0.4** | -10% |
| **稀有行为** (10-100) | F1 ~0.15-0.25 | **F1 ~0.05-0.15** | -40% |
| **极稀有** (<10 区间) | F1 ~0.05-0.10 | **F1 ~0.0-0.02** | -80% |

### 整体 F1 预估
- **V8.5 原版**: 0.2554（实测）
- **V8.5 无权重**: **0.22-0.25**（预估）
- **差异**: -2~5%

⚠️ **关键**: 稀有行为可能完全学不到，但常见行为表现相近

## 训练监控

### 关键指标

**正常**:
```
Epoch 10: Interval F1 = 0.23
  - attack: 0.48
  - mount: 0.35
  - sniff*: 0.30-0.40
  - rear: 0.25
  - selfgroom: 0.20
```

**警告**:
```
Epoch 50:
  - ejaculate: 0.00  ← 预期（太稀有）
  - biteobject: 0.00  ← 预期（太稀有）
  - freeze: 0.00  ← 可能的问题
```

### 何时停止

**成功标准**:
- 整体 F1 ≥ 0.23
- Top 10 行为 F1 ≥ 0.3
- 稀有行为出现预测（即使 F1 低）

**失败标准**:
- 20 epochs 后整体 F1 < 0.20
- 多个中等行为 F1 = 0.0
- → 改用 V8.5 原版（带类权重）

## 调优建议

### 如果稀有行为 F1 太低

**方案 1**: 提高 Focal Gamma
```yaml
focal_gamma: 2.5  # 从 2.0 提升
```

**方案 2**: 增加训练 epochs
```yaml
epochs: 150  # 从 100 提升
early_stopping_patience: 30  # 从 20 提升
```

**方案 3**: 降低学习率（让稀有类有更多机会学习）
```yaml
learning_rate: 0.00003  # 从 0.00005 降低
```

### 如果训练不稳定

**方案 1**: 降低 Focal Gamma
```yaml
focal_gamma: 1.5  # 从 2.0 降低（回到 V8.1 设置）
```

**方案 2**: 增加 Dropout
```yaml
dropout: 0.3  # 从 0.0 增加
```

## 对比实验建议

### 方案 A: 并行训练
```bash
# 终端 1: V8.5 无权重
python train_v8.5_local.py --config configs/config_v8.5_no_weights.yaml

# 终端 2: V8.5 原版
python train_v8.5_local.py --config configs/config_v8.5_full_behaviors.yaml
```

### 方案 B: 顺序训练
```bash
# 先跑无权重（快）
python train_v8.5_local.py --config configs/config_v8.5_no_weights.yaml

# 如果效果不好，再跑有权重
python train_v8.5_local.py --config configs/config_v8.5_full_behaviors.yaml
```

## 文件清单

### 新增文件
```
configs/
└── config_v8.5_no_weights.yaml  ← 配置文件

启动脚本:
└── start_v8.5_no_weights.bat    ← Windows 快捷启动

文档:
└── V8.5_NO_WEIGHTS_README.md    ← 本文件
```

### 复用文件（无需修改）
```
versions/v8_5_full_behaviors/    ← 模型、数据集
train_v8.5_local.py              ← 训练脚本
```

## FAQ

### Q: 为什么不用类权重？
**A**: 类权重计算慢、可能不稳定、且稀有行为在测试集中可能也稀有（低权重影响有限）

### Q: Focal Gamma 2.0 够吗？
**A**: 对常见/中等行为足够，稀有行为可能不够。可以提升到 2.5-3.0

### Q: 能用 V8.1 的后处理吗？
**A**: 可以，但需要更新 ID 映射（V8.1 是 28 类，V8.5 是 38 类）

### Q: 与 V8.1 有什么区别？
**A**: V8.1 只有 27 行为（28 类），V8.5 无权重有 37 行为（38 类）

### Q: 推荐吗？
**A**: 如果你只需要覆盖 38 类，不强求稀有行为高 F1，**推荐**。否则用 V8.5 原版。

## 总结

| 方面 | 评价 |
|-----|-----|
| **覆盖范围** | ✅ 37 行为（符合竞赛） |
| **训练速度** | ✅ 比 V8.5 原版快 10-15% |
| **稳定性** | ✅ 无极端权重，更稳定 |
| **常见行为 F1** | ✅ 与 V8.5 原版相近 |
| **稀有行为 F1** | ⚠️ 明显低于 V8.5 原版 |
| **适用场景** | ⚠️ 不追求极致性能时使用 |

---

**开始训练**:
```bash
start_v8.5_no_weights.bat
```

**对比训练**:
```bash
# 看看有无类权重的差异
python compare_configs.py configs/config_v8.5_full_behaviors.yaml configs/config_v8.5_no_weights.yaml
```
