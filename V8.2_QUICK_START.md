# V8.2 快速启动指南

## 🚀 立即开始

### Windows
```
start_v8.2_training.bat
```

### Linux/Mac
```bash
python train_v8.2_local.py
```

---

## ✨ V8.2 关键改进（基于 V8.1）

### 🎯 核心优化

#### 1. 验证平滑核 = 3（重要！）
- **从 5 降到 3**
- 更好地保留短时段行为
- 减少过度平滑导致的段丢失

#### 2. 降低 Sniff 类阈值（提升召回）
```yaml
sniffgenital: 0.25  # ↓ from 0.26
sniffface:    0.26  # ↓ from 0.28
sniffbody:    0.25  # ↓ from 0.28
```

#### 3. 增大 sniffbody 合并间隙
```yaml
sniffbody merge_gap: 8  # ↑ from 6
```
更容易合并碎片化的 sniffbody 段

#### 4. 保持的优化
- ✅ 运动门控（escape/chase ≥80 px/s, freeze ≤7 px/s）
- ✅ Intromit/Mount 校准
- ✅ 每个 epoch 计算 Kaggle F1
- ✅ 基于 Kaggle F1 保存最佳模型

---

## 📊 V8.2 vs V8.1 对比

| 特性 | V8.1 | V8.2 |
|------|------|------|
| 验证平滑核 | 5 | **3** ⭐ |
| sniffgenital | 0.26 | **0.25** |
| sniffface | 0.28 | **0.26** |
| sniffbody | 0.28 | **0.25** |
| sniffbody merge_gap | 6 | **8** |
| 运动门控 | ✅ | ✅ |
| Kaggle F1 跟踪 | ✅ | ✅ |

---

## 🎯 预期改进

相比 V8.1：
- **Sniffgenital/Sniffface/Sniffbody 召回**: +3~8%
- **短段检测**: 更好（平滑核=3）
- **Sniffbody 合并**: 更连续（merge_gap=8）
- **整体 F1**: +1~3%

---

## 🚀 使用流程

### 1. 启动训练
```bash
python train_v8.2_local.py
```

### 2. 监控输出
```
============================================================
V8.2 Fine-Tuned Multi-task Behavior Detection
Smoothing=3 + Lower Sniff Thresholds + Motion Gating
============================================================

Epoch 1/100
[Train] Loss: 0.3794 | Action Acc: 0.8383
[Val]   Loss: 0.3037 | Action Acc: 0.8694
[Kaggle] Interval F1: 0.6580 | Precision: 0.6920 | Recall: 0.6270

[OK] Saved best Kaggle F1 model (kaggle_f1=0.6580)
```

### 3. 训练完成后
```bash
# 检查模型
ls -lh checkpoints/v8.2_fine_tuned/best_model.pth

# 运行推理
python inference_v8.2.py

# 提交
python submit_to_kaggle.py submission_v8.2.csv
```

---

## 📁 保存的模型

- `best_model.pth` - **Kaggle F1 最高** ← 用于提交
- `best_model_acc.pth` - 帧准确率最高
- `last_model.pth` - 最新检查点

---

## ⏱️ 预计训练时间

- 每个 epoch: ~2.5 分钟
- 预计 epochs: 30-50
- **总时间: 1-2 小时**

---

## 🔧 技术细节

### V8.2 后处理配置
```python
CLASS_CONFIG = {
    'sniffgenital': {
        'prob_threshold': 0.25,  # V8.2: lowered
        'frac_high_threshold': 0.20
    },
    'sniffface': {
        'prob_threshold': 0.26,  # V8.2: lowered
        'frac_high_threshold': 0.20
    },
    'sniffbody': {
        'prob_threshold': 0.25,  # V8.2: lowered
        'merge_gap': 8,  # V8.2: increased
        'frac_high_threshold': 0.20
    },
    'escape': {
        'prob_threshold': 0.55,
        'max_required': 0.65,
        'velocity_min': 80.0  # Motion gating
    },
    'freeze': {
        'prob_threshold': 0.25,
        'velocity_max': 7.0  # Motion gating + threshold relaxation
    }
}
```

### 验证时平滑
```python
# V8.2: kernel_size=3 (was 5 in V8.1)
action_probs_smooth = temporal_smoothing(
    action_probs_flat,
    kernel_size=3,  # ⭐ Critical change
    method='median'
)
```

---

## ❓ FAQ

### Q: V8.2 和 V8.1 的主要区别？
A:
1. **平滑核从 5 降到 3** - 保留更多短段
2. **Sniff 类阈值降低** - 提升召回率
3. **sniffbody 合并间隙增大** - 减少碎片化

### Q: 为什么平滑核从 5 降到 3？
A: kernel_size=5 会过度平滑，丢失短时段行为。kernel_size=3 在降噪和保留短段之间更平衡。

### Q: 什么时候用 V8.2 而不是 V8.1？
A: 如果你发现 V8.1 在 sniff 类别的召回率不够，或者短段被过滤掉太多，用 V8.2。

### Q: 可以从 V8.1 模型继续训练吗？
A: 可以，复制权重：
```bash
cp checkpoints/v8.1_optimized/best_model.pth checkpoints/v8.2_fine_tuned/pretrained.pth
```

---

## 🎯 下一步优化方向

如果 V8.2 效果好，可以继续尝试：
1. 微调速度阈值（escape: 60~100 px/s）
2. 调整 sniff 的 max_required
3. 针对性优化低 F1 的类别

---

**准备好了吗？运行 `start_v8.2_training.bat` 开始训练！** 🚀
