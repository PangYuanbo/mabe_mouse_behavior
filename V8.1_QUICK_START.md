# V8.1 快速启动指南

## 🚀 立即开始

### Windows
双击运行：
```
start_v8.1_training.bat
```

### Linux/Mac
```bash
python train_v8.1_local.py
```

## ✨ V8.1 新特性

### 1️⃣ 每个 epoch 计算 Kaggle F1
- ✅ 不再只看准确率
- ✅ 直接优化 Kaggle 评分指标
- ✅ Early stopping 基于 Kaggle F1

### 2️⃣ 智能模型保存
3 个模型文件：
- `best_model.pth` - **Kaggle F1 最高** ← 用于提交
- `best_model_acc.pth` - 帧准确率最高
- `last_model.pth` - 最新检查点

### 3️⃣ 运动门控（Motion Gating）
自动过滤不符合运动特征的预测：
- **escape/chase**: 必须高速（≥80 px/s）
- **freeze**: 必须低速（≤7 px/s）

### 4️⃣ 精调阈值
针对每个行为类别优化：
- sniff: 控制误报 (↑ 0.50)
- sniffgenital: 提升召回 (↓ 0.26)
- intromit: 提升精度 (↑ 0.45)
- escape: 严格 + 速度门控

## 📊 训练输出

每个 epoch 你会看到：
```
[Kaggle] Interval F1: 0.6523 | Precision: 0.6891 | Recall: 0.6201
[OK] Saved best Kaggle F1 model (kaggle_f1=0.6523)
```

**Kaggle F1** 是最重要的指标！

## ⏱️ 预计时间

- 每个 epoch: ~2.5 分钟（训练 2 分钟 + 验证 30 秒）
- 预计训练: 30-50 epochs（早停）
- 总时间: **1-2 小时**

## 📈 预期性能

相比 V8：
- Escape FP: **-30~50%**（速度门控）
- Freeze Recall: **+10~20%**（阈值放宽）
- Intromit Precision: **+5~10%**（阈值提升）
- 整体 F1: **+2~5%**

## 🎯 训练完成后

### 1. 查看最佳模型
```bash
ls -lh checkpoints/v8.1_optimized/best_model.pth
```

### 2. 运行推理
```bash
python inference_v8.1.py \
  --checkpoint checkpoints/v8.1_optimized/best_model.pth \
  --output submission_v8.1.csv
```

### 3. 提交到 Kaggle
```bash
python submit_to_kaggle.py submission_v8.1.csv
```

## ❓ 常见问题

### Q: 为什么验证比以前慢？
A: 每个 epoch 都计算完整的 Kaggle F1（包括后处理），但这保证了模型优化方向正确。

### Q: 可以降低验证频率吗？
A: 不推荐。Kaggle F1 才是真正的目标，必须每轮监控。

### Q: best_model.pth 和 best_model_acc.pth 有什么区别？
A:
- `best_model.pth`: Kaggle F1 最高 ← **用这个提交**
- `best_model_acc.pth`: 帧准确率最高（可能过拟合）

### Q: 训练卡在某个 F1 值？
A: 正常，可能需要更多 epoch。Early stopping 会在 20 轮无提升后自动停止。

## 🔧 高级选项

### 调整速度阈值
编辑 `versions/v8_1_optimized_postproc/advanced_postprocessing.py`:
```python
'escape': {
    'velocity_min': 60.0  # 降低阈值，更宽松（默认 80）
}
```

### 调整类别阈值
同上文件中的 `CLASS_CONFIG` 字典

### 调整训练参数
编辑 `configs/config_v8.1_optimized.yaml`

---

**准备好了吗？运行 `start_v8.1_training.bat` 开始训练！** 🚀
