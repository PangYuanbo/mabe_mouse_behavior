# V8 Fine-Grained Behavior Detection - Changelog

## V8 vs V7 ä¸»è¦æ”¹è¿›

### ğŸ¯ æ ¸å¿ƒæ”¹è¿›

**V7é—®é¢˜**: åªé¢„æµ‹3ä¸ªç²—ç²’åº¦ç±»åˆ«(social/mating/aggressive)ï¼Œä¸ç¬¦åˆKaggleè¦æ±‚

**V8è§£å†³æ–¹æ¡ˆ**: å®Œæ•´å®ç°Kaggleç«èµ›æ ¼å¼çš„28ç±»ç²¾ç»†è¡Œä¸ºæ£€æµ‹

### ğŸ“Š å…³é”®å·®å¼‚å¯¹æ¯”

| ç‰¹æ€§ | V7 | V8 |
|------|----|----|
| **è¡Œä¸ºç±»åˆ«** | 3ç±»ç²—ç²’åº¦ | 28ç±»ç²¾ç»†ç²’åº¦ |
| **ä»»åŠ¡ç±»å‹** | å•ä»»åŠ¡(ä»…åŠ¨ä½œ) | å¤šä»»åŠ¡(åŠ¨ä½œ+æ–½åŠ¨è€…+å—åŠ¨è€…) |
| **è¾“å‡ºæ ¼å¼** | åŒºé—´æ£€æµ‹ | Kaggleæ ‡å‡†æ ¼å¼ |
| **Agent/Targeté¢„æµ‹** | âŒ ä¸æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒ |
| **Kaggleå…¼å®¹æ€§** | âŒ ä¸å…¼å®¹ | âœ… å®Œå…¨å…¼å®¹ |

### ğŸ†• V8æ–°å¢åŠŸèƒ½

#### 1. 28ç±»ç²¾ç»†è¡Œä¸ºåˆ†ç±»
```python
è¡Œä¸ºç±»åˆ«æ˜ å°„:
- ç¤¾äº¤è¡Œä¸º (7ç§): sniff, sniff_genital, sniff_face, approach, follow, etc.
- äº¤é…è¡Œä¸º (4ç§): mount, intromit, attempt_mount, ejaculate
- æ”»å‡»è¡Œä¸º (7ç§): attack, chase, chase_attack, bite, dominance, etc.
- å…¶ä»–è¡Œä¸º (10ç§): avoid, escape, freeze, allogroom, etc.
```

#### 2. å¤šä»»åŠ¡å­¦ä¹ æ¶æ„
```python
class V8BehaviorDetector:
    - å…±äº«CNN+LSTMéª¨å¹²ç½‘ç»œ
    - action_head: [B,T] â†’ 28ç±»åŠ¨ä½œ
    - agent_head: [B,T] â†’ 4åªè€é¼ (æ–½åŠ¨è€…)
    - target_head: [B,T] â†’ 4åªè€é¼ (å—åŠ¨è€…)
```

#### 3. Focal Losså¤„ç†ç±»åˆ«ä¸å¹³è¡¡
```python
FL(p_t) = -(1 - p_t)^Î³ * log(p_t)
gamma=2.0: èšç„¦å›°éš¾æ ·æœ¬
```

#### 4. Kaggleæäº¤æ ¼å¼
```python
è¾“å‡ºæ ¼å¼:
row_id, video_id, agent_id, target_id, action, start_frame, stop_frame
0, video1, mouse1, mouse2, sniff, 50, 120
1, video1, mouse2, mouse3, mount, 200, 350
```

### ğŸ› å·²ä¿®å¤é—®é¢˜

#### é—®é¢˜1: NaN Loss
**åŸå› **: æ··åˆç²¾åº¦è®­ç»ƒ(FP16)å¯¼è‡´Focal Lossæ•°å€¼ä¸ç¨³å®š
**è§£å†³**: ç¦ç”¨æ··åˆç²¾åº¦ `use_amp: false`
**ç»“æœ**: Lossæ­£å¸¸ä¸‹é™ 3.9 â†’ 0.4, å‡†ç¡®ç‡81%

#### é—®é¢˜2: å˜é•¿å…³é”®ç‚¹ç»´åº¦
**åŸå› **: ä¸åŒè§†é¢‘æœ‰ä¸åŒçš„bodypartæ•°é‡
**è§£å†³**: æ ‡å‡†åŒ–ä¸º7ä¸ªå›ºå®šèº«ä½“éƒ¨ä½ Ã— 4åªè€é¼  = 112ç»´
```python
æ ‡å‡†èº«ä½“éƒ¨ä½: nose, leftear, rightear, neck, lefthip, righthip, tail
```

#### é—®é¢˜3: Floatç±»å‹é”™è¯¯
**åŸå› **: `num_frames = df['video_frame'].max() + 1` è¿”å›float
**è§£å†³**: å¼ºåˆ¶è½¬æ¢ `num_frames = int(df['video_frame'].max()) + 1`

### ğŸ“ˆ è®­ç»ƒæ€§èƒ½

**RTX 5090é…ç½®**:
- Batch Size: 512
- åºåˆ—é•¿åº¦: 100å¸§
- å­¦ä¹ ç‡: 0.0001 (é™ä½ä»¥é˜²NaN)
- æ˜¾å­˜å ç”¨: ~24GB / 32GB
- è®­ç»ƒé€Ÿåº¦: ~18 it/s

**å½“å‰è®­ç»ƒæŒ‡æ ‡** (Epoch 1):
```
Actionå‡†ç¡®ç‡: 6% â†’ 81% (å¿«é€Ÿä¸Šå‡)
Agentå‡†ç¡®ç‡: 98% (ç¨³å®š)
Targetå‡†ç¡®ç‡: ~98% (é¢„è®¡)
Loss: 3.9 â†’ 0.4 (æ­£å¸¸ä¸‹é™)
```

### ğŸ”§ é…ç½®å»ºè®®

**å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³**:
```yaml
batch_size: 256  # é™ä½batch size
sequence_length: 80  # ç¼©çŸ­åºåˆ—
```

**å¦‚æœè®­ç»ƒä¸ç¨³å®š**:
```yaml
learning_rate: 0.00005  # è¿›ä¸€æ­¥é™ä½lr
focal_gamma: 1.5  # å‡å°gammaå€¼
```

**å¦‚æœæŸäº›ç±»åˆ«F1å¾ˆä½**:
- æ­£å¸¸ç°è±¡(ç¨€æœ‰è¡Œä¸ºæ ·æœ¬å°‘)
- å¯å°è¯•oversample_rare_classes: true
- ä½¿ç”¨ensembleå¤šæ¨¡å‹æŠ•ç¥¨

### ğŸ“ æ–‡ä»¶ç»“æ„

```
versions/v8_fine_grained/
â”œâ”€â”€ __init__.py              # åŒ…å¯¼å‡º
â”œâ”€â”€ action_mapping.py        # 28ç±»è¡Œä¸ºæ˜ å°„
â”œâ”€â”€ v8_model.py             # å¤šä»»åŠ¡æ¨¡å‹ + Focal Loss
â”œâ”€â”€ v8_dataset.py           # æ•°æ®é›†(å¸¦agent/target)
â”œâ”€â”€ submission_utils.py      # Kaggleæäº¤æ ¼å¼è½¬æ¢
â”œâ”€â”€ V8_DESIGN.md            # è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ V8_CHANGELOG.md         # æœ¬æ–‡æ¡£
â””â”€â”€ QUICKSTART.md           # å¿«é€Ÿå¼€å§‹æŒ‡å—

configs/
â””â”€â”€ config_v8_5090.yaml     # RTX 5090é…ç½®

train_v8_local.py           # è®­ç»ƒè„šæœ¬
test_v8.py                  # æµ‹è¯•è„šæœ¬
```

### ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. æµ‹è¯•æ‰€æœ‰ç»„ä»¶
python test_v8.py

# 2. å¼€å§‹è®­ç»ƒ
python train_v8_local.py --config configs/config_v8_5090.yaml

# 3. ç”ŸæˆKaggleæäº¤ (è®­ç»ƒå®Œæˆå)
python inference_v8.py --checkpoint checkpoints/v8_5090/best_model.pth
```

### âœ… V8æµ‹è¯•éªŒè¯

æ‰€æœ‰ç»„ä»¶æµ‹è¯•é€šè¿‡:
- âœ… åŠ¨ä½œæ˜ å°„ (28ç±»)
- âœ… æ¨¡å‹å‰å‘ä¼ æ’­
- âœ… å¤šä»»åŠ¡æŸå¤±è®¡ç®—
- âœ… åŒºé—´è½¬æ¢
- âœ… Kaggleæäº¤æ ¼å¼ç”Ÿæˆ

### ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

1. **Ensemble**: è®­ç»ƒå¤šä¸ªæ¨¡å‹å¹³å‡é¢„æµ‹
2. **åå¤„ç†**: å¹³æ»‘åŒºé—´è¾¹ç•Œã€å»é™¤çŸ­åŒºé—´
3. **ç‰¹å¾å·¥ç¨‹**: æ·»åŠ ç›¸å¯¹ä½ç½®ã€è·ç¦»ç­‰ç‰¹å¾
4. **å±‚æ¬¡åˆ†ç±»**: å…ˆé¢„æµ‹å¤§ç±»ï¼Œå†ç»†åˆ†
5. **ç±»åˆ«æƒé‡ä¼˜åŒ–**: æ ¹æ®éªŒè¯é›†F1è°ƒæ•´lossæƒé‡

---

**ç‰ˆæœ¬**: V8.0
**æ—¥æœŸ**: 2025-10-03
**çŠ¶æ€**: âœ… è®­ç»ƒä¸­ï¼ŒæŒ‡æ ‡æ­£å¸¸
