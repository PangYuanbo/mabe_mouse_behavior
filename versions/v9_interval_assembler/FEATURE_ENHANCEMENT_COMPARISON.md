# 特征增强方案对比

## 当前状态分析

### V8 模型当前特征（112维）
- **56维：** 原始坐标 (7个关键点 × 4只老鼠 × 2坐标)
- **28维：** 每个关键点的速度magnitude
- **28维：** 每个关键点的加速度magnitude

### 问题
虽然模型输入**已经包含速度和加速度**，但：
1. 模型可能没有充分利用这些特征
2. freeze类别需要**聚合的运动统计信息**（如整只老鼠的平均速度）
3. 缺少**运动稳定性**指标（如速度的标准差）
4. 缺少**相对运动特征**（老鼠之间的距离变化）

---

## 解决方案对比

### 方案1：硬编码速度门控（后处理）⚡

**实现方式：**
```python
# 在后处理中添加
FREEZE_VELOCITY_THRESHOLD = 92.22  # px/s
if segment_agent_velocity > FREEZE_VELOCITY_THRESHOLD:
    reject_prediction()
```

**优点：**
- ✅ 实现简单，立即可用
- ✅ 无需重新训练
- ✅ 基于数据分析的科学阈值
- ✅ 预期提升30-50%

**缺点：**
- ❌ 治标不治本
- ❌ 阈值固定，缺乏灵活性
- ❌ 只解决freeze问题，不能泛化到其他类别
- ❌ 需要手动为每个类别调整

**适用场景：**
- 快速验证速度特征的有效性
- 作为临时改进方案
- 与其他方案结合使用

---

### 方案2：增强运动特征（训练） 🎯 **推荐**

**实现方式：** 
见 `v8_dataset_enhanced.py`

**新增特征（144维总计）：**
- 56维：原始坐标
- 28维：逐关键点速度
- 28维：逐关键点加速度
- **20维：每只老鼠的聚合运动统计**
  - 4只 × (平均速度 + 最大速度 + 速度标准差 + 平均加速度 + 最大加速度)
- **12维：老鼠之间的相对运动**
  - 6对 × (距离 + 相对速度)

**优点：**
- ✅ **从根本上解决问题** - 模型学会使用运动特征
- ✅ **泛化能力强** - 自动适用于所有运动相关类别
- ✅ **可解释性好** - 新增特征明确对应运动语义
- ✅ 运动稳定性（速度std）**直接对应freeze特征**
- ✅ 相对运动特征帮助理解交互行为
- ✅ 特征维度增加合理（112 → 144，仅增加29%）

**缺点：**
- ❌ 需要重新训练（时间成本）
- ❌ 需要调整模型输入维度
- ❌ 可能需要更多训练epoch来学习新特征

**适用场景：**
- 长期解决方案
- 期望模型自动学习运动模式
- 想改进所有运动相关类别的识别

---

### 方案3：注意力机制强调运动特征 🔬

**实现方式：**
```python
class MotionAttentionLayer(nn.Module):
    """对速度/加速度特征施加注意力权重"""
    def forward(self, features):
        # features: [B, T, 112]
        coords = features[:, :, :56]
        motion = features[:, :, 56:]  # 速度+加速度
        
        # 计算motion的重要性权重
        attention = self.attention_layer(motion)
        enhanced_motion = motion * attention
        
        return torch.cat([coords, enhanced_motion], dim=-1)
```

**优点：**
- ✅ 显式引导模型关注运动特征
- ✅ 可学习的权重（比硬编码更灵活）
- ✅ 不改变输入维度

**缺点：**
- ❌ 架构变复杂
- ❌ 仍需要重新训练
- ❌ 可能过拟合

**适用场景：**
- 研究性质的探索
- 已经尝试方案2但效果不足时

---

## 推荐策略 🚀

### 阶段1：快速验证（1天）
使用**方案1（硬编码）**：
1. 在后处理中添加freeze的速度过滤
2. 运行验证集评估
3. 验证速度特征确实能提升freeze的F1

**目标：** 验证假设，预期freeze F1从0提升到0.03-0.05

---

### 阶段2：根本改进（3-5天）
使用**方案2（增强特征）**：
1. 使用 `v8_dataset_enhanced.py` 替换原数据集
2. 调整模型输入维度：112 → 144
3. 重新训练模型
4. 对比原模型和增强模型的性能

**目标：** 
- freeze F1提升到 0.08-0.15
- 其他运动相关类别（escape, chase）也得到改善
- 模型自动学会利用运动特征

---

### 阶段3：精细调优（可选）
如果阶段2效果很好，可以进一步：
1. 添加类别专属的loss权重
2. 使用hard negative mining
3. 添加temporal consistency正则化

---

## 特征维度详细对比

| 方案 | 总维度 | 新增特征 | 语义增强 |
|------|--------|----------|----------|
| **当前V8** | 112 | - | 基础运动 |
| **方案1（硬编码）** | 112 | 0 | 无（后处理） |
| **方案2（增强）** | 144 | +32 | ✅ 聚合统计 + 相对运动 |
| **方案3（注意力）** | 112 | 0 | ✅ 权重学习 |

---

## 新增特征的具体意义

### 每只老鼠的聚合统计（20维）

**为什么有用：**
- **平均速度：** 直接反映freeze vs background的主要区别
- **最大速度：** 捕捉突发运动（如escape, chase）
- **速度标准差：** 运动稳定性指标
  - **Freeze:** 低速度 + 低std（静止且稳定）
  - **Background:** 高速度 + 高std（随机运动）
- **平均加速度：** 运动变化率
- **最大加速度：** 突然启动/停止

**对freeze的帮助：**
```
Freeze特征签名：
- 平均速度：低（~40 px/s）
- 速度std：低（运动稳定）
- 最大速度：低（无突发）

Background特征签名：
- 平均速度：高（~113 px/s）
- 速度std：高（运动不稳定）
- 最大速度：更高
```

### 老鼠之间的相对特征（12维）

**为什么有用：**
- **距离：** 社交行为的重要指标
  - 近距离 → 交互行为（sniff, mount, attack等）
  - 远距离 → 独立行为（freeze, run等）
- **相对速度（距离变化率）：**
  - 正值：两只老鼠互相远离（escape, disengage）
  - 负值：两只老鼠互相接近（approach, chase）
  - 零值：保持固定距离（shepherd, 平行运动）

**对其他类别的帮助：**
- **Approach:** 相对速度为负（接近）
- **Escape:** 相对速度为正（远离）且agent速度高
- **Sniff系列:** 距离很小且相对速度接近0

---

## 实施建议

### 立即开始（今天）
```bash
# 1. 先用硬编码验证
python validate_with_velocity_filter.py

# 2. 如果有效，开始准备增强数据集
python test_v8_dataset_enhanced.py  # 测试加载
```

### 明天开始训练
```bash
# 使用增强特征重新训练
python train_v8_enhanced.py --epochs 30
```

### 评估对比
```bash
# 对比三个模型
python compare_models.py \
  --model1 v8_baseline.pth \
  --model2 v8_with_filter.pth \
  --model3 v8_enhanced.pth
```

---

## 总结

| 方案 | 实施难度 | 时间成本 | 预期提升 | 长期价值 |
|------|----------|----------|----------|----------|
| **方案1（硬编码）** | ⭐ 简单 | 1天 | +30-50% (freeze only) | ⭐⭐ 低 |
| **方案2（增强特征）** | ⭐⭐ 中等 | 3-5天 | +70-90% (多类别) | ⭐⭐⭐⭐⭐ 高 |
| **方案3（注意力）** | ⭐⭐⭐ 复杂 | 5-7天 | +50-70% | ⭐⭐⭐ 中 |

**最终推荐：** 先用**方案1快速验证**（几小时），然后立即开始**方案2的训练**（最优解）。

你觉得这个计划如何？需要我帮你准备哪一步的代码？
