# V8.1 启动指南

## ✅ 准备完成

所有 V8.1 文件已创建并验证：

### 📁 文件结构
```
versions/v8_1_optimized_postproc/
├── advanced_postprocessing.py  # V8.1 优化后处理（运动门控）
└── README.md                   # 改进说明

configs/
└── config_v8.1_optimized.yaml  # V8.1 配置

train_v8.1_local.py             # V8.1 训练脚本
inference_v8.1.py               # V8.1 推理脚本
```

## 🚀 启动训练

### 直接启动（推荐）
```bash
python train_v8.1_local.py
```

这将：
- 使用配置 `configs/config_v8.1_optimized.yaml`
- **每个 epoch 都计算 Kaggle F1 评分**
- 保存 3 个模型：
  - `best_model.pth` - **Kaggle F1 最高的模型（用于提交）**
  - `best_model_acc.pth` - 验证准确率最高的模型
  - `last_model.pth` - 最新的模型

### 从 V8 safe 继续训练
```bash
# 1. 复制 V8 safe 的权重作为初始化
mkdir -p checkpoints/v8.1_optimized
cp checkpoints/v8_5090_safe/best_model.pth checkpoints/v8.1_optimized/pretrained.pth

# 2. 修改训练脚本加载预训练权重（可选）
# 或者直接从头训练，让模型学习 V8.1 的新特性
python train_v8.1_local.py
```

## 🎯 主要改进

### 1. 运动门控（Motion Gating）
- **escape/chase**: 要求速度 ≥ 80 px/s
- **freeze**: 要求速度 ≤ 7 px/s，且阈值放宽到 0.20

### 2. 精调阈值
- **sniff**: `max_required = 0.50` (控制 FP)
- **sniffgenital**: `prob_threshold = 0.26` (提升召回)
- **sniffbody**: `merge_gap = 6` (更好合并)
- **intromit**: `prob_threshold = 0.45` (提升精度)
- **mount**: `prob_threshold = 0.43`
- **approach**: `prob_threshold = 0.42` (控制噪音)
- **escape**: 保持高阈值 + 速度门控

### 3. 解码优化
- `smoothing_kernel = 3` (短段友好)
- 边界精调窗口 `±2`
- action-only 分段 + 投票 + 合并 + 边界优化

## 📊 训练监控

### 训练输出示例
```
============================================================
V8.1 Optimized Multi-task Behavior Detection
Motion Gating + Fine-tuned Thresholds
============================================================
Device: cuda
GPU: NVIDIA GeForce RTX 5090
...

============================================================
Epoch 1/100
============================================================
Training: 100%|████████| 1993/1993 [02:10<00:00, 15.27it/s]
Validation: 100%|██████| 46/46 [00:15<00:00, 30.90it/s]

[Train] Loss: 0.3794 | Action Acc: 0.8383 | Agent Acc: 0.9799 | Target Acc: 0.8883
[Val]   Loss: 0.3037 | Action Acc: 0.8694 | Agent Acc: 0.9855 | Target Acc: 0.9117
[Kaggle] Interval F1: 0.6523 | Precision: 0.6891 | Recall: 0.6201

[OK] Saved best accuracy model (val_acc=0.8694)
[OK] Saved best Kaggle F1 model (kaggle_f1=0.6523)
```

### 关键指标说明
- **Action Acc**: 帧级分类准确率（训练指标）
- **Interval F1**: Kaggle 评分指标（**最重要！用于 early stopping**）
- **Precision/Recall**: 区间检测的精度和召回

### 模型保存策略
每个 epoch 结束时：
1. 如果 **Kaggle F1** 提升 → 保存为 `best_model.pth` ✅ **（用于提交）**
2. 如果 Action Acc 提升 → 保存为 `best_model_acc.pth`
3. 无条件保存 `last_model.pth`

**Early Stopping**: 基于 Kaggle F1，20 个 epoch 无提升则停止

## 🧪 验证和推理

### 使用训练脚本的验证（自动）
训练过程会自动在验证集上运行，使用 V8.1 后处理

### 单独推理（测试集）
```bash
python inference_v8.1.py \
  --checkpoint checkpoints/v8.1_optimized/best_model.pth \
  --config configs/config_v8.1_optimized.yaml \
  --output submission_v8.1.csv
```

## 📈 预期提升

相比 V8：
- **Escape FP**: 显著减少（速度门控）
- **Freeze 召回**: 提升（速度低时放宽阈值）
- **Intromit/Mount 精度**: 提升（更严格阈值 + 校准）
- **Sniffbody 合并**: 更好（gap=6）
- **整体 F1**: 预期提升 1-3%

## ⚠️ 注意事项

1. **确保数据路径正确**：检查 `config_v8.1_optimized.yaml` 中的 `data_dir`
2. **GPU 内存**：batch_size=256，约需 12GB VRAM（5090 完全够用）
3. **训练时间**：每个 epoch 约 2-3 分钟
4. **Early stopping**: patience=20，如果 20 个 epoch 无提升会自动停止

## 🔧 故障排除

### 问题：导入错误
```bash
# 测试导入
python -c "from versions.v8_1_optimized_postproc.advanced_postprocessing import probs_to_intervals_advanced; print('OK')"
```

### 问题：找不到数据
检查配置文件中的路径：
```bash
cat configs/config_v8.1_optimized.yaml | grep data_dir
```

### 问题：CUDA out of memory
降低 batch_size：
```yaml
# 在 config_v8.1_optimized.yaml 中
batch_size: 128  # 从 256 降到 128
```

## 📝 下一步

1. 启动训练
2. 观察验证集性能
3. 如果效果好，准备 Kaggle 提交
4. 可以尝试微调超参数（如速度阈值 80→60 或 80→100）
