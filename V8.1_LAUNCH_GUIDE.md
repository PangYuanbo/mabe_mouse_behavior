# V8.1 å¯åŠ¨æŒ‡å—

## âœ… å‡†å¤‡å®Œæˆ

æ‰€æœ‰ V8.1 æ–‡ä»¶å·²åˆ›å»ºå¹¶éªŒè¯ï¼š

### ğŸ“ æ–‡ä»¶ç»“æ„
```
versions/v8_1_optimized_postproc/
â”œâ”€â”€ advanced_postprocessing.py  # V8.1 ä¼˜åŒ–åå¤„ç†ï¼ˆè¿åŠ¨é—¨æ§ï¼‰
â””â”€â”€ README.md                   # æ”¹è¿›è¯´æ˜

configs/
â””â”€â”€ config_v8.1_optimized.yaml  # V8.1 é…ç½®

train_v8.1_local.py             # V8.1 è®­ç»ƒè„šæœ¬
inference_v8.1.py               # V8.1 æ¨ç†è„šæœ¬
```

## ğŸš€ å¯åŠ¨è®­ç»ƒ

### ç›´æ¥å¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
python train_v8.1_local.py
```

è¿™å°†ï¼š
- ä½¿ç”¨é…ç½® `configs/config_v8.1_optimized.yaml`
- **æ¯ä¸ª epoch éƒ½è®¡ç®— Kaggle F1 è¯„åˆ†**
- ä¿å­˜ 3 ä¸ªæ¨¡å‹ï¼š
  - `best_model.pth` - **Kaggle F1 æœ€é«˜çš„æ¨¡å‹ï¼ˆç”¨äºæäº¤ï¼‰**
  - `best_model_acc.pth` - éªŒè¯å‡†ç¡®ç‡æœ€é«˜çš„æ¨¡å‹
  - `last_model.pth` - æœ€æ–°çš„æ¨¡å‹

### ä» V8 safe ç»§ç»­è®­ç»ƒ
```bash
# 1. å¤åˆ¶ V8 safe çš„æƒé‡ä½œä¸ºåˆå§‹åŒ–
mkdir -p checkpoints/v8.1_optimized
cp checkpoints/v8_5090_safe/best_model.pth checkpoints/v8.1_optimized/pretrained.pth

# 2. ä¿®æ”¹è®­ç»ƒè„šæœ¬åŠ è½½é¢„è®­ç»ƒæƒé‡ï¼ˆå¯é€‰ï¼‰
# æˆ–è€…ç›´æ¥ä»å¤´è®­ç»ƒï¼Œè®©æ¨¡å‹å­¦ä¹  V8.1 çš„æ–°ç‰¹æ€§
python train_v8.1_local.py
```

## ğŸ¯ ä¸»è¦æ”¹è¿›

### 1. è¿åŠ¨é—¨æ§ï¼ˆMotion Gatingï¼‰
- **escape/chase**: è¦æ±‚é€Ÿåº¦ â‰¥ 80 px/s
- **freeze**: è¦æ±‚é€Ÿåº¦ â‰¤ 7 px/sï¼Œä¸”é˜ˆå€¼æ”¾å®½åˆ° 0.20

### 2. ç²¾è°ƒé˜ˆå€¼
- **sniff**: `max_required = 0.50` (æ§åˆ¶ FP)
- **sniffgenital**: `prob_threshold = 0.26` (æå‡å¬å›)
- **sniffbody**: `merge_gap = 6` (æ›´å¥½åˆå¹¶)
- **intromit**: `prob_threshold = 0.45` (æå‡ç²¾åº¦)
- **mount**: `prob_threshold = 0.43`
- **approach**: `prob_threshold = 0.42` (æ§åˆ¶å™ªéŸ³)
- **escape**: ä¿æŒé«˜é˜ˆå€¼ + é€Ÿåº¦é—¨æ§

### 3. è§£ç ä¼˜åŒ–
- `smoothing_kernel = 3` (çŸ­æ®µå‹å¥½)
- è¾¹ç•Œç²¾è°ƒçª—å£ `Â±2`
- action-only åˆ†æ®µ + æŠ•ç¥¨ + åˆå¹¶ + è¾¹ç•Œä¼˜åŒ–

## ğŸ“Š è®­ç»ƒç›‘æ§

### è®­ç»ƒè¾“å‡ºç¤ºä¾‹
```
============================================================
V8.1 Optimized Multi-task Behavior Detection
Motion Gating + Fine-tuned Thresholds
============================================================
Device: cuda
GPU: NVIDIA GeForce RTX 5090
...

============================================================
Epoch 1/100
============================================================
Training: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1993/1993 [02:10<00:00, 15.27it/s]
Validation: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 46/46 [00:15<00:00, 30.90it/s]

[Train] Loss: 0.3794 | Action Acc: 0.8383 | Agent Acc: 0.9799 | Target Acc: 0.8883
[Val]   Loss: 0.3037 | Action Acc: 0.8694 | Agent Acc: 0.9855 | Target Acc: 0.9117
[Kaggle] Interval F1: 0.6523 | Precision: 0.6891 | Recall: 0.6201

[OK] Saved best accuracy model (val_acc=0.8694)
[OK] Saved best Kaggle F1 model (kaggle_f1=0.6523)
```

### å…³é”®æŒ‡æ ‡è¯´æ˜
- **Action Acc**: å¸§çº§åˆ†ç±»å‡†ç¡®ç‡ï¼ˆè®­ç»ƒæŒ‡æ ‡ï¼‰
- **Interval F1**: Kaggle è¯„åˆ†æŒ‡æ ‡ï¼ˆ**æœ€é‡è¦ï¼ç”¨äº early stopping**ï¼‰
- **Precision/Recall**: åŒºé—´æ£€æµ‹çš„ç²¾åº¦å’Œå¬å›

### æ¨¡å‹ä¿å­˜ç­–ç•¥
æ¯ä¸ª epoch ç»“æŸæ—¶ï¼š
1. å¦‚æœ **Kaggle F1** æå‡ â†’ ä¿å­˜ä¸º `best_model.pth` âœ… **ï¼ˆç”¨äºæäº¤ï¼‰**
2. å¦‚æœ Action Acc æå‡ â†’ ä¿å­˜ä¸º `best_model_acc.pth`
3. æ— æ¡ä»¶ä¿å­˜ `last_model.pth`

**Early Stopping**: åŸºäº Kaggle F1ï¼Œ20 ä¸ª epoch æ— æå‡åˆ™åœæ­¢

## ğŸ§ª éªŒè¯å’Œæ¨ç†

### ä½¿ç”¨è®­ç»ƒè„šæœ¬çš„éªŒè¯ï¼ˆè‡ªåŠ¨ï¼‰
è®­ç»ƒè¿‡ç¨‹ä¼šè‡ªåŠ¨åœ¨éªŒè¯é›†ä¸Šè¿è¡Œï¼Œä½¿ç”¨ V8.1 åå¤„ç†

### å•ç‹¬æ¨ç†ï¼ˆæµ‹è¯•é›†ï¼‰
```bash
python inference_v8.1.py \
  --checkpoint checkpoints/v8.1_optimized/best_model.pth \
  --config configs/config_v8.1_optimized.yaml \
  --output submission_v8.1.csv
```

## ğŸ“ˆ é¢„æœŸæå‡

ç›¸æ¯” V8ï¼š
- **Escape FP**: æ˜¾è‘—å‡å°‘ï¼ˆé€Ÿåº¦é—¨æ§ï¼‰
- **Freeze å¬å›**: æå‡ï¼ˆé€Ÿåº¦ä½æ—¶æ”¾å®½é˜ˆå€¼ï¼‰
- **Intromit/Mount ç²¾åº¦**: æå‡ï¼ˆæ›´ä¸¥æ ¼é˜ˆå€¼ + æ ¡å‡†ï¼‰
- **Sniffbody åˆå¹¶**: æ›´å¥½ï¼ˆgap=6ï¼‰
- **æ•´ä½“ F1**: é¢„æœŸæå‡ 1-3%

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¡®ä¿æ•°æ®è·¯å¾„æ­£ç¡®**ï¼šæ£€æŸ¥ `config_v8.1_optimized.yaml` ä¸­çš„ `data_dir`
2. **GPU å†…å­˜**ï¼šbatch_size=256ï¼Œçº¦éœ€ 12GB VRAMï¼ˆ5090 å®Œå…¨å¤Ÿç”¨ï¼‰
3. **è®­ç»ƒæ—¶é—´**ï¼šæ¯ä¸ª epoch çº¦ 2-3 åˆ†é’Ÿ
4. **Early stopping**: patience=20ï¼Œå¦‚æœ 20 ä¸ª epoch æ— æå‡ä¼šè‡ªåŠ¨åœæ­¢

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ï¼šå¯¼å…¥é”™è¯¯
```bash
# æµ‹è¯•å¯¼å…¥
python -c "from versions.v8_1_optimized_postproc.advanced_postprocessing import probs_to_intervals_advanced; print('OK')"
```

### é—®é¢˜ï¼šæ‰¾ä¸åˆ°æ•°æ®
æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„ï¼š
```bash
cat configs/config_v8.1_optimized.yaml | grep data_dir
```

### é—®é¢˜ï¼šCUDA out of memory
é™ä½ batch_sizeï¼š
```yaml
# åœ¨ config_v8.1_optimized.yaml ä¸­
batch_size: 128  # ä» 256 é™åˆ° 128
```

## ğŸ“ ä¸‹ä¸€æ­¥

1. å¯åŠ¨è®­ç»ƒ
2. è§‚å¯ŸéªŒè¯é›†æ€§èƒ½
3. å¦‚æœæ•ˆæœå¥½ï¼Œå‡†å¤‡ Kaggle æäº¤
4. å¯ä»¥å°è¯•å¾®è°ƒè¶…å‚æ•°ï¼ˆå¦‚é€Ÿåº¦é˜ˆå€¼ 80â†’60 æˆ– 80â†’100ï¼‰
