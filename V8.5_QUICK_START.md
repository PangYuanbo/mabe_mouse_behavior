# V8.5 Quick Start Guide

## üéØ What is V8.5?

V8.5 is a **critical fix** for V8/V8.1 to achieve **full competition compliance**.

### The Problem
- V8/V8.1 only predicted **27 behaviors**
- **11 behaviors** were incorrectly mapped to background
- **7,985 annotated intervals** were ignored
- **Not compliant** with competition requirement: "identify over 30 different social and non-social behaviors"

### The Solution
- V8.5 predicts **ALL 37 behaviors**
- **NUM_ACTIONS = 38** (0=background + 37 behaviors)
- **0 ignored intervals**
- **Fully compliant** with competition

## üöÄ Quick Start (3 Steps)

### Step 1: Verify Setup

```bash
# Check that data is in place
ls data/kaggle/train_annotation/

# Test action mapping
python -c "from versions.v8_5_full_behaviors.action_mapping import NUM_ACTIONS, print_mapping_summary; print(f'NUM_ACTIONS: {NUM_ACTIONS}'); print_mapping_summary()"
```

**Expected output:**
```
NUM_ACTIONS: 38
Total classes: 38 (0=background, 1-37=behaviors)
...
```

### Step 2: Start Training

**Option A - Using batch script (Windows):**
```bash
start_v8.5_training.bat
```

**Option B - Direct command:**
```bash
python train_v8.5_local.py --config configs/config_v8.5_full_behaviors.yaml
```

**Expected behavior:**
- Class weights computed (shows 38 classes)
- Model created with 38 action classes
- Training starts with Kaggle F1 computed every epoch

### Step 3: Monitor Training

Watch for:
```
[OK] NUM_ACTIONS: 38 (0=background + 37 behaviors)
[OK] Total parameters: ~8,500,000
Computing class weights (strategy=inverse_sqrt_freq)...
Class distribution:
  [ 0] background          : xxx,xxx,xxx (xx.xx%)
  [ 1] sniff               : x,xxx,xxx (xx.xx%)
  ...
[Kaggle] Interval F1: 0.xxxx | Precision: 0.xxxx | Recall: 0.xxxx
```

## üìä What Changed from V8.1?

| Aspect | V8.1 | V8.5 |
|--------|------|------|
| Behaviors | 27 | **37** |
| NUM_ACTIONS | 28 | **38** |
| Ignored intervals | 7,985 | **0** |
| Non-social behaviors | ‚ùå Mapped to 0 | ‚úÖ Unique IDs |
| Competition compliant | ‚ùå No | ‚úÖ Yes |

### New Behaviors in V8.5

**Previously mapped to background (ID 0):**
1. rear (ID 31) - 4,408 intervals
2. selfgroom (ID 27) - 1,356 intervals
3. dig (ID 33) - 1,127 intervals
4. climb (ID 34) - 1,010 intervals
5. genitalgroom (ID 26) - 50 intervals
6. dominancemount (ID 29) - 410 intervals
7. tussle (ID 30) - 122 intervals
8. rest (ID 32) - 233 intervals
9. exploreobject (ID 35) - 105 intervals
10. biteobject (ID 36) - 33 intervals
11. submit (ID 37) - 86 intervals

**Removed:**
- bite (was ID 15) - not in training data

## ‚öôÔ∏è Configuration Highlights

```yaml
# configs/config_v8.5_full_behaviors.yaml

num_actions: 38  # Key change!

# Essential for 38 classes with severe imbalance
use_class_weights: true
class_weight_strategy: 'inverse_sqrt_freq'

# Focal loss helps with hard/rare behaviors
use_focal_loss: true
focal_gamma: 1.5

# Batch size (RTX 5090)
batch_size: 256

# Same architecture as V8
conv_channels: [128, 256, 512]
lstm_hidden: 256
lstm_layers: 2
```

## üìà Expected Results

### Training Time
- **Same as V8.1** (~X hours on RTX 5090)
- May require more epochs due to more classes

### F1 Score
- **Individual behaviors**: Significant improvement on newly included behaviors
- **Overall F1**: Modest improvement (depends on test distribution)
- **Coverage**: 100% of annotated behaviors (was ~85%)

### Checkpoints
Training saves to `checkpoints/v8.5_full_behaviors/`:
- `best_model.pth` - Best Kaggle F1
- `best_model_acc.pth` - Best frame accuracy
- `last_model.pth` - Latest epoch

## üîç Validation

### During Training
Every epoch shows:
```
[Kaggle] Interval F1: 0.xxxx | Precision: 0.xxxx | Recall: 0.xxxx

Top 20 Classes (sorted by support):
  sniff                 : F1=0.xxx (was 0.xxx)
  sniffgenital          : F1=0.xxx (was 0.xxx)
  attack                : F1=0.xxx (was 0.xxx)
  rear                  : F1=0.xxx (NEW!)  ‚Üê Previously ignored
  ...
```

### After Training
Check per-class performance:
```bash
python -c "
from versions.v8_5_full_behaviors.action_mapping import ID_TO_ACTION, NUM_ACTIONS
print(f'Total behaviors: {NUM_ACTIONS - 1}')  # -1 for background
for i in range(1, min(11, NUM_ACTIONS)):
    print(f'{i:2d}. {ID_TO_ACTION[i]}')
"
```

## ‚ö†Ô∏è Important Notes

### 1. Cannot Reuse V8.1 Weights
- Different output dimension (28 ‚Üí 38)
- Must train from scratch

### 2. Class Weights Are Critical
- Without them, rare behaviors won't be learned
- `ejaculate` has only 3 intervals!

### 3. Longer Training Possible
- 38 classes vs 28
- May need more epochs to converge

### 4. Memory Usage
- Slightly higher (38 vs 28 output classes)
- Negligible difference (~0.001% params)

## üêõ Troubleshooting

### Issue: "NUM_ACTIONS mismatch"
**Solution:** Make sure you're importing from `v8_5_full_behaviors`, not `v8_fine_grained`

### Issue: "Class weights not computed"
**Solution:** Set `use_class_weights: true` in config

### Issue: "Very low F1 on rare behaviors"
**Solution:**
- Increase `focal_gamma` (try 2.0)
- Use `class_weight_strategy: 'inverse_freq'` (more aggressive)
- Train longer

### Issue: "Training slower than V8.1"
**Expected:** Slightly slower due to more classes, but <5% difference

## üìö Further Reading

- **Full documentation**: `versions/v8_5_full_behaviors/README.md`
- **Competition rules**: `COMPETITION_RULES.md`
- **Label analysis**: `analyze_label_distribution_detailed.py`

## ‚úÖ Checklist Before Training

- [ ] Confirmed NUM_ACTIONS = 38
- [ ] Config file uses `config_v8.5_full_behaviors.yaml`
- [ ] Class weights enabled
- [ ] Data directory correct
- [ ] Sufficient disk space for checkpoints (~500MB)
- [ ] RTX 5090 available (or adjust batch_size)

## üéØ Success Criteria

After training, you should see:
- ‚úÖ All 37 behaviors in evaluation output
- ‚úÖ No "ignored" intervals
- ‚úÖ Per-class F1 for rare behaviors (even if low)
- ‚úÖ Checkpoints saved successfully

---

**Ready to start? Run:**
```bash
start_v8.5_training.bat
```

**Questions? Check:**
- README: `versions/v8_5_full_behaviors/README.md`
- Config: `configs/config_v8.5_full_behaviors.yaml`
